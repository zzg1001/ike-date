<?xml version="1.0" encoding="UTF-8"?>
<job>
  <name>job_base_outsourced_risk_price</name>
  <description/>
  <extended_description/>
  <job_version/>
  <directory>/</directory>
  <created_user>-</created_user>
  <created_date>2024/06/27 12:40:34.579</created_date>
  <modified_user>-</modified_user>
  <modified_date>2024/06/27 12:40:34.579</modified_date>
  <parameters>
    </parameters>
  <connection>
    <name>ODS_HANA</name>
    <server>172.16.31.42</server>
    <type>MSSQL</type>
    <access>Native</access>
    <database>ODS_HANA</database>
    <port>1433</port>
    <username>dw</username>
    <password>Encrypted 2be98afc86aa7f2e4cb79ce10bef2abcd</password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute>
        <code>EXTRA_OPTION_MSSQL.zeroDateTimeBehavior</code>
        <attribute>convertToNull</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>MSSQL_DOUBLE_DECIMAL_SEPARATOR</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>1433</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <slaveservers>
    </slaveservers>
  <job-log-table>
    <connection/>
    <schema/>
    <table/>
    <size_limit_lines/>
    <interval/>
    <timeout_days/>
    <field>
      <id>ID_JOB</id>
      <enabled>Y</enabled>
      <name>ID_JOB</name>
    </field>
    <field>
      <id>CHANNEL_ID</id>
      <enabled>Y</enabled>
      <name>CHANNEL_ID</name>
    </field>
    <field>
      <id>JOBNAME</id>
      <enabled>Y</enabled>
      <name>JOBNAME</name>
    </field>
    <field>
      <id>STATUS</id>
      <enabled>Y</enabled>
      <name>STATUS</name>
    </field>
    <field>
      <id>LINES_READ</id>
      <enabled>Y</enabled>
      <name>LINES_READ</name>
    </field>
    <field>
      <id>LINES_WRITTEN</id>
      <enabled>Y</enabled>
      <name>LINES_WRITTEN</name>
    </field>
    <field>
      <id>LINES_UPDATED</id>
      <enabled>Y</enabled>
      <name>LINES_UPDATED</name>
    </field>
    <field>
      <id>LINES_INPUT</id>
      <enabled>Y</enabled>
      <name>LINES_INPUT</name>
    </field>
    <field>
      <id>LINES_OUTPUT</id>
      <enabled>Y</enabled>
      <name>LINES_OUTPUT</name>
    </field>
    <field>
      <id>LINES_REJECTED</id>
      <enabled>Y</enabled>
      <name>LINES_REJECTED</name>
    </field>
    <field>
      <id>ERRORS</id>
      <enabled>Y</enabled>
      <name>ERRORS</name>
    </field>
    <field>
      <id>STARTDATE</id>
      <enabled>Y</enabled>
      <name>STARTDATE</name>
    </field>
    <field>
      <id>ENDDATE</id>
      <enabled>Y</enabled>
      <name>ENDDATE</name>
    </field>
    <field>
      <id>LOGDATE</id>
      <enabled>Y</enabled>
      <name>LOGDATE</name>
    </field>
    <field>
      <id>DEPDATE</id>
      <enabled>Y</enabled>
      <name>DEPDATE</name>
    </field>
    <field>
      <id>REPLAYDATE</id>
      <enabled>Y</enabled>
      <name>REPLAYDATE</name>
    </field>
    <field>
      <id>LOG_FIELD</id>
      <enabled>Y</enabled>
      <name>LOG_FIELD</name>
    </field>
    <field>
      <id>EXECUTING_SERVER</id>
      <enabled>N</enabled>
      <name>EXECUTING_SERVER</name>
    </field>
    <field>
      <id>EXECUTING_USER</id>
      <enabled>N</enabled>
      <name>EXECUTING_USER</name>
    </field>
    <field>
      <id>START_JOB_ENTRY</id>
      <enabled>N</enabled>
      <name>START_JOB_ENTRY</name>
    </field>
    <field>
      <id>CLIENT</id>
      <enabled>N</enabled>
      <name>CLIENT</name>
    </field>
  </job-log-table>
  <jobentry-log-table>
    <connection/>
    <schema/>
    <table/>
    <timeout_days/>
    <field>
      <id>ID_BATCH</id>
      <enabled>Y</enabled>
      <name>ID_BATCH</name>
    </field>
    <field>
      <id>CHANNEL_ID</id>
      <enabled>Y</enabled>
      <name>CHANNEL_ID</name>
    </field>
    <field>
      <id>LOG_DATE</id>
      <enabled>Y</enabled>
      <name>LOG_DATE</name>
    </field>
    <field>
      <id>JOBNAME</id>
      <enabled>Y</enabled>
      <name>TRANSNAME</name>
    </field>
    <field>
      <id>JOBENTRYNAME</id>
      <enabled>Y</enabled>
      <name>STEPNAME</name>
    </field>
    <field>
      <id>LINES_READ</id>
      <enabled>Y</enabled>
      <name>LINES_READ</name>
    </field>
    <field>
      <id>LINES_WRITTEN</id>
      <enabled>Y</enabled>
      <name>LINES_WRITTEN</name>
    </field>
    <field>
      <id>LINES_UPDATED</id>
      <enabled>Y</enabled>
      <name>LINES_UPDATED</name>
    </field>
    <field>
      <id>LINES_INPUT</id>
      <enabled>Y</enabled>
      <name>LINES_INPUT</name>
    </field>
    <field>
      <id>LINES_OUTPUT</id>
      <enabled>Y</enabled>
      <name>LINES_OUTPUT</name>
    </field>
    <field>
      <id>LINES_REJECTED</id>
      <enabled>Y</enabled>
      <name>LINES_REJECTED</name>
    </field>
    <field>
      <id>ERRORS</id>
      <enabled>Y</enabled>
      <name>ERRORS</name>
    </field>
    <field>
      <id>RESULT</id>
      <enabled>Y</enabled>
      <name>RESULT</name>
    </field>
    <field>
      <id>NR_RESULT_ROWS</id>
      <enabled>Y</enabled>
      <name>NR_RESULT_ROWS</name>
    </field>
    <field>
      <id>NR_RESULT_FILES</id>
      <enabled>Y</enabled>
      <name>NR_RESULT_FILES</name>
    </field>
    <field>
      <id>LOG_FIELD</id>
      <enabled>N</enabled>
      <name>LOG_FIELD</name>
    </field>
    <field>
      <id>COPY_NR</id>
      <enabled>N</enabled>
      <name>COPY_NR</name>
    </field>
  </jobentry-log-table>
  <channel-log-table>
    <connection/>
    <schema/>
    <table/>
    <timeout_days/>
    <field>
      <id>ID_BATCH</id>
      <enabled>Y</enabled>
      <name>ID_BATCH</name>
    </field>
    <field>
      <id>CHANNEL_ID</id>
      <enabled>Y</enabled>
      <name>CHANNEL_ID</name>
    </field>
    <field>
      <id>LOG_DATE</id>
      <enabled>Y</enabled>
      <name>LOG_DATE</name>
    </field>
    <field>
      <id>LOGGING_OBJECT_TYPE</id>
      <enabled>Y</enabled>
      <name>LOGGING_OBJECT_TYPE</name>
    </field>
    <field>
      <id>OBJECT_NAME</id>
      <enabled>Y</enabled>
      <name>OBJECT_NAME</name>
    </field>
    <field>
      <id>OBJECT_COPY</id>
      <enabled>Y</enabled>
      <name>OBJECT_COPY</name>
    </field>
    <field>
      <id>REPOSITORY_DIRECTORY</id>
      <enabled>Y</enabled>
      <name>REPOSITORY_DIRECTORY</name>
    </field>
    <field>
      <id>FILENAME</id>
      <enabled>Y</enabled>
      <name>FILENAME</name>
    </field>
    <field>
      <id>OBJECT_ID</id>
      <enabled>Y</enabled>
      <name>OBJECT_ID</name>
    </field>
    <field>
      <id>OBJECT_REVISION</id>
      <enabled>Y</enabled>
      <name>OBJECT_REVISION</name>
    </field>
    <field>
      <id>PARENT_CHANNEL_ID</id>
      <enabled>Y</enabled>
      <name>PARENT_CHANNEL_ID</name>
    </field>
    <field>
      <id>ROOT_CHANNEL_ID</id>
      <enabled>Y</enabled>
      <name>ROOT_CHANNEL_ID</name>
    </field>
  </channel-log-table>
  <pass_batchid>N</pass_batchid>
  <shared_objects_file/>
  <entries>
    <entry>
      <name>Start</name>
      <description/>
      <type>SPECIAL</type>
      <attributes/>
      <start>Y</start>
      <dummy>N</dummy>
      <repeat>N</repeat>
      <schedulerType>0</schedulerType>
      <intervalSeconds>0</intervalSeconds>
      <intervalMinutes>60</intervalMinutes>
      <hour>12</hour>
      <minutes>0</minutes>
      <weekDay>1</weekDay>
      <DayOfMonth>1</DayOfMonth>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>208</xloc>
      <yloc>144</yloc>
      <attributes_kjc/>
    </entry>
    <entry>
      <name>成功</name>
      <description/>
      <type>SUCCESS</type>
      <attributes/>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>560</xloc>
      <yloc>208</yloc>
      <attributes_kjc/>
    </entry>
    <entry>
      <name>SQL</name>
      <description/>
      <type>SQL</type>
      <attributes/>
      <sql>      
TRUNCATE table Purchase_Dashboard.dbo.base_outsourced_risk_price ;
INSERT INTO Purchase_Dashboard.dbo.base_outsourced_risk_price 

select 
a.part_code
,a.part_name
,m.ltext makt
,plant
,purchase_group_code
,purchase_group_desc
,purchase_importance_type
,purchase_cycle
,material_desc
,plant_code
,stock_quantity
,sap_unit
,sap_price
,b.windchill_part_name
,model_specifications
,source
,unit_code
,alien_code
,order_no
,manufacturer
,standard_no
,supplier
,status_indication
,item_classification_code
,description
,Windchill_sample
,supplier_cd
,supplier_name
,examine_price
,valid_end_date
,actual_purchase_name
,inquiry_cd
from (
				     select 
				     
							CASE 
								        WHEN PATINDEX('%[^0]%', a.MATNR  ) > 0 
								        THEN SUBSTRING(a.MATNR  , PATINDEX('%[^0]%', a.MATNR  ), LEN(a.MATNR  ))
								        ELSE  a.MATNR
						  END AS part_code
				           ,a.MAKTX    as part_name -- 物料计划名称
				           ,''         as makt      -- 物料计划描述（长文本）
				           ,'2000'     as plant      -- makt
				           ,c.EKGRP    as purchase_group_code      -- 采购组
				           ,d.EKNAM    as purchase_group_desc      --'采购组描述'
				            ,c.MAABC   as purchase_importance_type --'采购重要度分类'
				            ,c.PLIFZ   as purchase_cycle           --'计划周期（天）'
							,material_desc  as material_desc
							,plant_code     as plant_code
							,stock_quantity as stock_quantity
				           ,b.sap_unit      as sap_unit                 --'计划单位'
				           ,bb.sap_price    as sap_price
				      from ODS_HANA.dbo.MAKT a
				 left join (select DISTINCT
								   MEINS as sap_unit
								  ,MATNR as part_code -- 物料代码
						     from ODS_HANA.dbo.MARA
				           ) b
				        on a.MATNR = b.part_code
				  left join (
				      select 
						    CASE  WHEN MATNR LIKE '%.%' THEN REPLACE(MATNR, '\.[0-9]+$', '' ) ELSE MATNR end part_code
						    ,lplpr  sap_price
						    from ODS_HANA.dbo.MBEW where bwkey =2000
				         ) bb 
				        on a.MATNR = bb.part_code
				 left join ODS_HANA.dbo.MARC c 
				        on a.MATNR = c.MATNR
				       and c.WERKS=2000
				 left join ODS_HANA.dbo.T024 d 
				        on c.EKGRP = d.EKGRP
				 left join (
							  SELECT material_code
									,material_desc
									,plant_code
									,stock_quantity
				  FROM Report0624.dbo.r24_stock_detail
				  where plant_code = 2000
				
				             ) e
				           on a.MATNR = e.material_code
						    where c.EKGRP in ('201','211','214','215','204','205')
           )a 


left join (

	           select   CASE
						    WHEN part_code LIKE '%sh' OR part_code LIKE '%SH' 
						    THEN SUBSTRING(part_code, 1, LEN(part_code) - 2)
						    ELSE part_code
						  END AS part_code
						,windchill_part_name   -- '物料技术名称'           
						,model_specifications  --'物料技术型号（规格）' 
						,unit_code             --'技术单位'              
						,alien_code            --'外来代码'        
						,order_no              --'订货号'           
						,manufacturer          --'技术要求品牌(制造商)'          
						,standard_no           --'标准号'           
						,supplier              -- '供应商' 
						,source                -- '来源'   
						,status_indication     -- '状态标识'      
						,item_classification_code  -- '项目分类'
						,description           -- 'description'
				             ,'' Windchill_sample  --  '样本（即时要求低的从数据中台抽）'

	               from (
							select 
									CASE 
													WHEN PATINDEX('%[^0]%', part_code  ) > 0 
													THEN SUBSTRING(part_code  , PATINDEX('%[^0]%', part_code  ), LEN(part_code ))
													ELSE  part_code
									END AS part_code
									,part_name windchill_part_name  -- '物料技术名称'           
									,model_specifications  --'物料技术型号（规格）' 
									,unit_code             --'技术单位'              
									,alien_code            --'外来代码'        
									,order_no              --'订货号'           
									,manufacturer          --'技术要求品牌(制造商)'          
									,standard_no           --'标准号'           
									,supplier              -- '供应商' 
									,source                -- '来源'   
									,status_indication     -- '状态标识'      
									,item_classification_code  -- '项目分类'
									,description           -- 'description'
									,'' Windchill_sample  --  '样本（即时要求低的从数据中台抽）'		
							from DWD_WINDCHILL.dbo.dws_pdm_part_info where is_new = 1
							)a
                        ) b
       on a.part_code = b.part_code
left join  [ODS_HANA].[dbo].[LTXT_purchase] m 
       on a.part_code = m.matnr
left join (

			
			                 select 
			                         CASE 
								        WHEN PATINDEX('%[^0]%', item_cd  ) > 0 
								        THEN SUBSTRING(item_cd  , PATINDEX('%[^0]%', item_cd  ), LEN(item_cd ))
								        ELSE  item_cd
						             END AS part_code    
									,a.supplier_cd     -- '采购供应商代码'
									,a.supplier_name   -- '采购供应商'
									,a.examine_price    -- '采购单价'
									,a.valid_end_date  -- '价格有效期'
									,b.actual_purchase_name -- '采购方式（招标、单一来源等）'
			                        ,b.inquiry_cd          -- '招标文件编号
			
						from (
								select 
								    item_cd
									,supplier_cd     -- '采购供应商代码'
									,supplier_name   -- '采购供应商'
									,examine_price    -- '采购单价'
									,valid_end_date  -- '价格有效期'
									,form_num
								from (
										  select 
												item_cd
												,supplier_cd     -- '采购供应商代码'
												,supplier_name   -- '采购供应商'
												,examine_price    -- '采购单价'
												,valid_end_date  -- '价格有效期'
												,form_num
										        ,ROW_NUMBER()over(PARTITION by item_cd ORDER by examine_price ) rn 
										from ODS_SRM.dbo.srm_price_item a
										where DELETEd=0 
										and PUrchaser_cd=2000 
									    and  len(item_cd)>1
								) a where rn = 1
						) a 
			left join ODS_SRM.dbo.srm_inq_supplier_confirm_head_field b 
			      on a.form_num  = b.CONFIRM_NUM 
			      and b.DELETED = 0
      ) c
      on  a.part_code = c.part_code</sql>
      <useVariableSubstitution>F</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename/>
      <sendOneStatement>F</sendOneStatement>
      <connection>ODS_HANA</connection>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>400</xloc>
      <yloc>240</yloc>
      <attributes_kjc/>
    </entry>
  </entries>
  <hops>
    <hop>
      <from>Start</from>
      <to>SQL</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>Y</unconditional>
    </hop>
    <hop>
      <from>SQL</from>
      <to>成功</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
  </hops>
  <notepads>
  </notepads>
  <attributes/>
</job>
